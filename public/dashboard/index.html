<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Mitra Dashboard</title>

<style>
body{font-family:Arial;background:#0f172a;color:white;margin:0}
#login{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh}
.container{display:flex;height:100vh}
.sidebar{width:300px;background:#020617;padding:10px;overflow:auto}
.msg{padding:10px;border-bottom:1px solid #333;cursor:pointer}
.bubble{margin:10px;padding:10px;border-radius:10px;max-width:70%}
.user{background:#1e293b}
.ai{background:#16a34a;margin-left:auto}
</style>
</head>

<body>

<div id="login">
<h2>Dashboard Privat</h2>
<input id="p" type="password" placeholder="Password">
<button onclick="login()">Masuk</button>
</div>

<div id="main" style="display:none" class="container">
<div class="sidebar" id="list"></div>
<div style="flex:1" id="chat"></div>
</div>

<script>

async function login(){
  const pass=document.getElementById("p").value;

  const r=await fetch("/api/login",{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({ pass })
  });

  if(r.ok){
    start();
  }else{
    alert("Salah");
  }
}

async function start(){
  document.getElementById("login").style.display="none";
  document.getElementById("main").style.display="flex";
  load();
}

let all=[];

async function load(){
  const r = await fetch("/api/getChats");

  if(r.status===401){
    location.reload();
    return;
  }

  const data = await r.json();
  all=data.slice(1);

  const grouped={};
  all.forEach(r=> grouped[r[1]]=r );

  const list=document.getElementById("list");
  list.innerHTML="";

  Object.keys(grouped).forEach(p=>{
    list.innerHTML+=`
      <div class="msg" onclick="openChat('${p}')">
        ${p}<br><small>${grouped[p][3]}</small>
      </div>`;
  });
}

function openChat(p){
  const box=document.getElementById("chat");
  box.innerHTML="";

  all.filter(r=>r[1]===p).forEach(r=>{
    box.innerHTML+=`
      <div class="bubble user">${r[3]}</div>
      <div class="bubble ai">${r[4]||""}</div>`;
  });
}

setInterval(load,3000);

</script>
</body>
</html>
